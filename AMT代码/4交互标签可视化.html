<!-- HTML 部分 -->
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMT 任务</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script> <!-- 引入xlsx库 -->
    <!-- CSS 部分 -->
    <style>
        /* 页面整体布局 */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f4f4f4;
            flex-direction: column;
        }

        /* 容器的基本样式 */
        .container {
            width: 80%;
            height: 80vh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: row;
            text-align: center;
            margin-left: 20px;  /* 左侧的间距 */
            margin-right: 20px; /* 右侧的间距 */
        }

        /* 左侧部分 */
        .left {
            width: 20%;  /* 左侧容器宽度 */
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            text-align: left;
            margin-left: 40px; /* 增加左边距 */
            height: 100%; /* 确保左侧容器和右侧容器的高度一致 */
        }

        .left img {
            max-width: 100%;
            height: auto;
            margin-bottom: 20px;  /* 让图片和标题之间有 20px 的间距 */
        }

        .left h3 {
            margin-bottom: 20px;
            font-size: 24px;
            color: #333;
            padding-top: 3px;  /* 给左侧标题增加上边距，确保与右侧对齐 */
        }

        .left p {
            font-size: 16px;
            color: #666;
        }

        /* 文本框样式 */
        .text-box {
            margin-top: 0px; /* 调整文本框和图片之间的间距 */
            padding: 10px;
            font-size: 18px;
            width: 60%;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 10px;
            background-color: #f9f9f9;
            color: #333;
            font-weight: bold;
        }

        /* 撤销按钮的样式 */
        .undo-btn {
            margin-top: 20px; /* 添加顶部间距，使按钮与文本框保持间距 */
            padding: 12px 30px;
            font-size: 17px;
            background-color: #4CAF50;  /* 撤销按钮为红色 */
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            text-align: center; /* 确保按钮文本居中对齐 */
            width: 210px;  /* 或者设置固定宽度，如 150px */
        }
        .undo-btn:hover {
            background-color: #4CAF50;  /* 撤销按钮悬停时颜色变化 */
        }

        /* 中间部分 */
        .middle {
            width: 35%;  /* 中间部分占据较小区域 */
            text-align: center;
            position: relative;
        }

        /* 图片容器 */
        .image-container {
            border: 2px solid #ddd;  /* 为图片添加边界框 */
            padding: 10px;
            display: inline-block;
            margin-bottom: 20px;
        }

        .middle img {
            width: 100%;
            max-height: 80vh;
            object-fit: contain;
        }

        /* Start 和 End 按钮 */
        .start-btn, .end-btn {
            position: absolute;
            top: -60px; /* 调整按钮位置，使其更远离图片 */
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        .start-btn:hover, .end-btn:hover {
            background-color: #45a049;
        }

        .end-btn {
            display: none; /* 初始时隐藏 End 按钮 */
        }

        /* 右侧部分 */
        .right {
            width: 20%;  /* 右侧容器宽度变小 */
            padding: 20px;
            text-align: left;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            margin-right: 40px; /* 增加右边距 */
            height: 100%; /* 确保右侧容器和左侧容器的高度一致 */
        }

        .right h3 {
            margin-bottom: 20px;
            font-size: 24px;
            color: #333;
            padding-top: 40px;  /* 给右侧标题增加上边距，确保与左侧对齐 */
        }

        .right p {
            font-size: 16px;
            color: #666;
        }

        /* 强调文本的样式 */
        .important-text {
            font-size: 18px;          /* 增大字体 */
            font-weight: bold;        /* 加粗 */
            color: #333;              /* 颜色更深，更显眼 */
            margin: 20px 0;           /* 添加上下间距 */
        }
    </style>
</head>
<body>

<!-- 主体容器 -->
<div class="container">
    <!-- 左侧任务说明部分-->
    <div class="left">
        <!-- 添加文本框 -->
        <input class="text-box" type="text" value="此处显示交互类型" readonly>
        <button class="undo-btn" onclick="undoAction()">撤销上一步操作</button> <!-- 添加撤销按钮 -->
        <h3>Description</h3>
        <img src="C:\Users\cyd\Desktop\说明英文版.png" alt="说明图">
    </div>

    <!-- 中间部分：显示图片和按钮 -->
    <div class="middle">
        <button class="start-btn" onclick="startTracking()">Start</button>
        <button class="end-btn" onclick="endTracking()">End</button>
        <div class="image-container">
            <img id="taskImage" src="D:/UI数据集收集/自己收集/来自MobileViews/注册或登录/89974.jpg" alt="Task Image">
        </div>
    </div>

    <!-- 右侧说明部分-->
    <div class="right">
        <h3>Task Description</h3>
        <p class="important-text">Please use the mouse and keyboard to simulate various touchscreen operations on the screenshot in the center to complete the login task</p>
        <p class="important-text">Click the 'Start' button to begin interacting with the image, and click the 'End' button to finish data collection after completing the task.</p>
    </div>
</div>

<!-- JavaScript 部分 -->
<script src="https://blog-static.cnblogs.com/files/axqa/cursor-effects.js">
    let collectedData = [];  // 用于收集数据

    document.addEventListener("DOMContentLoaded", function () {
        let taskImage = document.getElementById('taskImage');
        // 定义全局变量，存储图片的显示尺寸
        let displayedWidth = 0;
        let displayedHeight = 0;
        let thresholdCalculated = false;  // 新增标志变量

        // 确保图片加载完毕后获取尺寸
        taskImage.onload = function() {
            displayedWidth = taskImage.clientWidth;  // 图片在页面上显示的宽度
            displayedHeight = taskImage.clientHeight; // 图片在页面上显示的高度
            console.log('图片的显示尺寸:', displayedWidth, displayedHeight);
            // 计算滑动阈值，并设置标志
            const slideThreshold = Math.min(displayedWidth * 0.04, displayedHeight * 0.04);
            console.log('计算的滑动阈值:', slideThreshold);
            thresholdCalculated = true;  // 设为已计算
        }

        // 如果图片已经加载，直接获取尺寸
        if (taskImage.complete) {
            taskImage.onload();
        }

        // 撤销操作
        window.undoAction = function() {
            updateTextBox("撤销上一步操作");  // 更新文本框为“撤销上一步操作”
            console.log("标签: 撤销上一步操作");
        }

        let trackingStarted = false;
        let startTime = 0;
        let endTime = 0;
        let startCoords = { x: 0, y: 0 };
        let endCoords = { x: 0, y: 0 };
        let keyPressed = false;
        let keyDown = null; // 用来保存按下的键值（例如 "D", "I", "O", "T"）

        // 启动数据收集
        window.startTracking = function() {
            trackingStarted = true;
            document.querySelector('.start-btn').style.display = 'none';
            document.querySelector('.end-btn').style.display = 'inline-block';
            
            // 记录开始时间
            startTime = new Date().getTime();
            document.getElementById('taskImage').addEventListener('mousedown', handleMouseDown);
            document.getElementById('taskImage').addEventListener('mouseup', handleMouseUp);
            document.getElementById('taskImage').addEventListener('mousemove', handleMouseMove);
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
        };

        // 结束数据收集
        window.endTracking = function() {
            trackingStarted = false;
            document.querySelector('.start-btn').style.display = 'inline-block';
            document.querySelector('.end-btn').style.display = 'none';
            
            // 移除鼠标事件监听器
            document.getElementById('taskImage').removeEventListener('mousedown', handleMouseDown);
            document.getElementById('taskImage').removeEventListener('mouseup', handleMouseUp);
            document.getElementById('taskImage').removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('keydown', handleKeyDown);
            document.removeEventListener('keyup', handleKeyUp);


            exportToExcel(collectedData);
            
        };

        // 处理键盘按下事件
        function handleKeyDown(event) {
            keyDown = event.key; // 保存按下的键
            if (keyDown === "D" || keyDown === "I" || keyDown === "O" || keyDown === "T") {
                keyPressed = true;
            }
        }

        // 监听键盘按下事件
        document.addEventListener('keydown', function(event) {
            if (event.key === "Enter") {
                updateTextBox("回车键");
                console.log("标签: 回车键");
                recordData("回车键", startTime, new Date().getTime(), startCoords, endCoords); // 记录数据
            }
        });

        // 处理键盘抬起事件
        function handleKeyUp(event) {
            keyPressed = false;
            keyDown = null; // 释放按键，避免后续误记录
        }

        // 处理鼠标按下事件
        function handleMouseDown(event) {
            if (trackingStarted) {
                startCoords = { x: event.offsetX, y: event.offsetY };
                startTime = new Date().getTime(); // 记录开始时间
                console.log(`鼠标点击开始 - 时间: ${startTime}, 坐标: (${startCoords.x}, ${startCoords.y})`);
                updateTextBox("点击操作");  // 更新文本框为“点击操作”
                event.preventDefault(); // 禁止图片拖动
            }
        }

        // 处理鼠标抬起事件
        function handleMouseUp(event) {
            if (trackingStarted) {
                endCoords = { x: event.offsetX, y: event.offsetY };
                endTime = new Date().getTime(); // 记录结束时间
                const duration = endTime - startTime; // 计算持续时间
                const distance = Math.sqrt(Math.pow(endCoords.x - startCoords.x, 2) + Math.pow(endCoords.y - startCoords.y, 2)); // 计算位移
                
                // 只有在阈值已经计算过后才进行判断
                if (thresholdCalculated) {
                    // 设定滑动阈值，取宽度和高度的 5% 中的较小值
                    const slideThreshold = Math.min(displayedWidth * 0.04, displayedHeight * 0.04); 
                  

                    // 根据操作类型输出标签，并更新文本框内容
                    if (duration < 500 && distance < slideThreshold) {
                        updateTextBox("点击");
                        console.log("标签: 点击操作");
                        recordData("点击", startTime, endTime, startCoords, endCoords); // 记录数据
                    } else if (duration >= 500 && distance < slideThreshold) {
                        updateTextBox("长按");
                        console.log("标签: 长按操作");
                        recordData("长按", startTime, endTime, startCoords, endCoords); // 记录数据
                    } else if (distance > slideThreshold) {
                        updateTextBox("滑动");
                        console.log("标签: 滑动操作");
                        recordData("滑动", startTime, endTime, startCoords, endCoords); // 记录数据
                        if (keyDown === "D") {
                            updateTextBox("拖动");
                            console.log("标签: 拖动操作");
                            recordData("拖动", startTime, endTime, startCoords, endCoords); // 记录数据
                        }
                    }
                }


                // 判断是否为缩放操作
                if (keyDown === "I") {
                    updateTextBox("缩放 - 放大");
                    console.log("标签: 缩放 - 放大操作");
                    recordData("缩放 - 放大", startTime, endTime, startCoords, endCoords); // 记录数据
                } else if (keyDown === "O") {
                    updateTextBox("缩放 - 缩小");
                    console.log("标签: 缩放 - 缩小操作");
                    recordData("缩放 - 缩小", startTime, endTime, startCoords, endCoords); // 记录数据
                }

                // 判断是否为文本输入操作
                if (keyDown === "T") {
                    updateTextBox("文本输入");
                    console.log("标签: 文本输入操作");
                    recordData("文本输入", startTime, endTime, startCoords, endCoords); // 记录数据
                }

                console.log(`鼠标点击结束 - 时间: ${endTime}, 持续时间: ${duration} 毫秒, 位移: ${distance}px, 坐标: (${endCoords.x}, ${endCoords.y})`);
                event.preventDefault(); // 禁止图片拖动

           
            }
        }

        // 处理鼠标移动事件（滑动操作）
        function handleMouseMove(event) {
            if (trackingStarted && event.buttons === 1) { // 判断是否按下鼠标左键（滑动）
                endCoords = { x: event.offsetX, y: event.offsetY }; // 实时更新结束坐标
            }
        }

        // 更新文本框内容
        function updateTextBox(text) {
            document.querySelector('.text-box').value = text;  // 将标签文本赋值给文本框
        }

        function recordData(actionType, startTime, endTime, startCoords, endCoords) {
            let data = {
                action: actionType,
                startTime: startTime,
                endTime: endTime,
                startCoords: `${startCoords.x}, ${startCoords.y}`,
                endCoords: `${endCoords.x}, ${endCoords.y}`
            }

            collectedData.push(data);  // 保存数据
        }

        function exportToExcel(data) {
            const ws = XLSX.utils.json_to_sheet(data); // 将JSON数据转换为工作表
            const wb = XLSX.utils.book_new(); // 创建一个新的工作簿
            XLSX.utils.book_append_sheet(wb, ws, "TaskData"); // 将工作表添加到工作簿中
            XLSX.writeFile(wb, "task_data.xlsx"); // 下载Excel文件
        }
    });
</script>
</body>
</html>